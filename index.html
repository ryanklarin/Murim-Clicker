<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Murim Clicker</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body style="background-color:#2d2d30;">

    <p id="cultivationLevelText" style="color:white; font-size: 60px; text-align: center; margin-top: 20px;">Mortal</p>

    <img draggable="false" class="image glow" src="images/mortal.png" onclick="addToScore()">

    <p style="color:white;" class="qi-text">Qi: <span id="qi">0</span></p>

    <p style="color:white;" class="qisec-text">Qi/s: <span id="qiPerSecond">0</span></p>

    <div id="button-container">
        <button onclick="breakthrough()" id="breakthrough-button" class="breakthrough-button rounded">
            <div class="progress-bar"></div>
            Breakthrough <span id="breakthroughCost">25</span>
        </button>

        <button onclick="rebirth()" id="rebirth-button" class="breakthrough-button rounded" style="display: none;">
            <div class="progress-bar"></div>
            Rebirth <span id="rebirthCost">25</span>
        </button>

        <p class="rebirth-info">Rebirth <span id="rebirthCount">0</span> - <span id="rebirthMultiplier">1</span>x</p>
    </div>

    <!-- Reset Button -->
    <button id="reset-button" class="reset-button" onclick="showResetConfirmation()">RESET</button>

    <!-- Reset Confirmation Dialog -->
    <div id="reset-confirmation" class="reset-confirmation" style="display: none;">
        <div class="reset-dialog">
            <h2>Reset Game</h2>
            <p>Are you sure you want to reset ALL data? This cannot be undone!</p>
            <div class="reset-buttons">
                <button onclick="resetGame()" class="confirm-reset">Yes, Reset Everything</button>
                <button onclick="hideResetConfirmation()" class="cancel-reset">No, Cancel</button>
            </div>
        </div>
    </div>

    <!-- Amulet System UI -->
    <button id="inventory-button" class="inventory-button" onclick="toggleInventory()">
        <img src="images/bag.png" alt="Inventory" style="width: 30px; height: 30px;">
    </button>

    <button id="avatar-button" class="avatar-button" onclick="goToAvatarSelection()">
        <img src="images/avatar.png" alt="Avatar" style="width: 30px; height: 30px;">
    </button>

    <div id="inventory-menu" class="inventory-menu" style="display: none;">
        <div class="inventory-header">
            <h2>Amulet Inventory</h2>
            <button onclick="toggleInventory()" class="close-button">Ã—</button>
        </div>
        <div class="equipment-slots">
            <h3>Equipped Amulets</h3>
            <div id="equipment-slots" class="equipment-grid">
                <!-- Equipment slots will be added here -->
            </div>
        </div>
        <div class="inventory-grid">
            <h3>Inventory</h3>
            <div id="inventory-grid" class="inventory-grid">
                <!-- Inventory slots will be added here -->
            </div>
        </div>
    </div>

    <script>
        var qi = 0;
        var qiPerSecond = 0;
        var baseQiPerSecond = 2; // Base Qi per second
        var currentQiPerSecond = 0; // Store the current calculated qi/s
        var qiPerClick = 1; // Initial Qi per click
        var rebirthMultiplier = 1; // Base multiplier
        var rebirthCount = 0; // Track number of rebirths
        var lastMajorBreakthrough = -1; // Track the last major breakthrough level

        var breakthroughCost = 25;
        var cultivationLevel = -1; // Start with -1 to show "Mortal" before the first breakthrough
        var breakthroughCostMultiplier = 1.5; // Base cost multiplier

        // List of cultivation levels
        const levelText = [
            "Mortal",
            "Body Tempering I", "Body Tempering II", "Body Tempering III", "Body Tempering IV", "Body Tempering V",
            "Body Tempering VI", "Body Tempering VII", "Body Tempering VIII", "Body Tempering IX", "Body Tempering X",
            "Qi Condensation I", "Qi Condensation II", "Qi Condensation III", "Qi Condensation IV", "Qi Condensation V",
            "Qi Condensation VI", "Qi Condensation VII", "Qi Condensation VIII", "Qi Condensation IX", "Qi Condensation X",
            "Foundation Establishment I", "Foundation Establishment II", "Foundation Establishment III", "Foundation Establishment IV", "Foundation Establishment V",
            "Foundation Establishment VI", "Foundation Establishment VII", "Foundation Establishment VIII", "Foundation Establishment IX", "Foundation Establishment X",
            "Core Formation I", "Core Formation II", "Core Formation III", "Core Formation IV", "Core Formation V",
            "Core Formation VI", "Core Formation VII", "Core Formation VIII", "Core Formation IX", "Core Formation X",
            "Soul Formation I", "Soul Formation II", "Soul Formation III", "Soul Formation IV", "Soul Formation V",
            "Soul Formation VI", "Soul Formation VII", "Soul Formation VIII", "Soul Formation IX", "Soul Formation X",
            "Saint - Initial Stage", "Saint - Middle Stage", "Saint - Final Stage",
            "Emperor - Initial Stage", "Emperor - Middle Stage", "Emperor - Final Stage",
            "Supreme Emperor - Initial Stage", "Supreme Emperor - Middle Stage", "Supreme Emperor - Final Stage",
            "Great Emperor - Initial Stage", "Great Emperor - Middle Stage", "Great Emperor - Final Stage",
            "Transcendent", "Immortal"
        ];

        // Multipliers for different breakthroughs
        const minorMultiplier = 2.5;
        const majorMultiplier = 8;
        const majorBreakthroughCostMultiplier = 5;

        // Major Breakthrough Levels
        const majorBreakthroughLevels = [
            10,   // From Body Tempering X to Qi Condensation I
            20,  // From Qi Condensation X to Foundation Establishment I
            30,  // From Foundation Establishment X to Core Formation I
            40,  // From Core Formation X to Soul Formation I
            50,  // From Soul Formation X to Saint - Initial Stage
            53,  // From Saint - Final Stage to Emperor - Initial Stage
            56,  // From Emperor - Final Stage to Supreme Emperor - Initial Stage
            59,  // From Supreme Emperor - Final Stage to Great Emperor - Initial Stage
            62   // From Great Emperor - Final Stage to Transcendent
        ];

        // Amulet System
        const amuletTiers = {
            wooden: { multiplier: 1.25, chance: 0.4 },
            stone: { multiplier: 1.5, chance: 0.25 },
            bone: { multiplier: 2, chance: 0.15 },
            silver: { multiplier: 2.5, chance: 0.1 },
            gold: { multiplier: 3, chance: 0.07 },
            emerald: { multiplier: 4, chance: 0.03 }
        };

        const amuletTypes = {
            power: { name: "Power", effect: "click" },
            patience: { name: "Patience", effect: "idle" }
        };

        var inventory = [];
        var equippedAmulets = [];
        var maxEquippedSlots = 2; // Base number of slots

        var selectedAvatar = localStorage.getItem('selectedAvatar') || 'male.png';

        function calculateRebirthCost() {
            // Calculate what the next major breakthrough would cost
            let tempCost = breakthroughCost;
            let tempLevel = cultivationLevel;
            let costScaling = 1 + (tempLevel * 0.025);
            return Math.round(tempCost * breakthroughCostMultiplier * costScaling * majorBreakthroughCostMultiplier + (rebirthCount * 250));
        }

        function calculateBaseQi(level) {
            // Find the last major breakthrough before or at this level
            let lastMajor = -1;
            for (let i = 0; i <= level; i++) {
                if (majorBreakthroughLevels.includes(i)) {
                    lastMajor = i;
                }
            }

            // Calculate base growth
            let baseGrowth = Math.pow(1.75, level);
            
            // Add boost around Foundation Establishment (level 20)
            if (level >= 20 && level < 30) {
                baseGrowth *= 1.5; // 50% boost for Foundation Establishment
            } else if (level >= 30 && level < 40) {
                baseGrowth *= 2; // 100% boost for Core Formation
            } else if (level >= 40 && level < 50) {
                baseGrowth *= 2.5; // 150% boost for Soul Formation
            } else if (level >= 50 && level < 53) {
                baseGrowth *= 3; // 200% boost for Saint - Initial Stage
            }
            
            // If we've had a major breakthrough, multiply by its effect
            if (lastMajor !== -1) {
                baseGrowth *= majorMultiplier;
            }

            return baseQiPerSecond * baseGrowth;
        }

        function updateQiPerSecond() {
            // Calculate base qi/s
            let baseQi = calculateBaseQi(cultivationLevel);
            
            // Apply breakthrough multiplier (only for minor breakthroughs)
            let breakthroughMultiplier = majorBreakthroughLevels.includes(cultivationLevel) ? 1 : minorMultiplier;
            
            // Apply rebirth multiplier
            let totalMultiplier = breakthroughMultiplier * rebirthMultiplier;
            
            // Apply amulet multipliers
            equippedAmulets.forEach(amulet => {
                if (amulet.type === 'patience') {
                    totalMultiplier *= amulet.multiplier;
                }
            });
            
            // Update the current qi/s
            currentQiPerSecond = baseQi * totalMultiplier;
        }

        function breakthrough() {
            // Prevent breakthrough if already at Immortal
            if (cultivationLevel >= levelText.length - 2) {
                return;
            }

            if (qi >= breakthroughCost) {
                qi -= breakthroughCost;
                cultivationLevel++;

                // Update qiPerSecond calculation
                updateQiPerSecond();

                // Increase qiPerClick with diminishing returns
                // Major breakthroughs give a bigger click boost
                if (majorBreakthroughLevels.includes(cultivationLevel)) {
                    if (cultivationLevel < 30) {
                        qiPerClick *= 3; // Big boost for early major breakthroughs
                    } else {
                        qiPerClick *= 2; // Smaller boost for later major breakthroughs
                    }
                } else {
                    if (cultivationLevel < 30) {
                        qiPerClick *= 1.8; // Strong early growth
                    } else {
                        qiPerClick *= (1.3 + (1 / (cultivationLevel + 5))); // Reduced scaling later
                    }
                }

                // Increase breakthroughCost with dynamic scaling
                let costScaling = 1 + (cultivationLevel * 0.025); // Slightly smaller scaling
                let baseCostIncrease = breakthroughCostMultiplier * costScaling;
                if (majorBreakthroughLevels.includes(cultivationLevel)) {
                    baseCostIncrease *= majorBreakthroughCostMultiplier; // Keeps major breakthroughs impactful
                }
                breakthroughCost = Math.round(breakthroughCost * baseCostIncrease);

                // Visual feedback for major breakthroughs
                if (majorBreakthroughLevels.includes(cultivationLevel)) {
                    document.getElementById("cultivationLevelText").style.color = "#FFD700"; // Gold color
                    setTimeout(() => {
                        document.getElementById("cultivationLevelText").style.color = "white";
                    }, 2000);
                }

                updateDisplay();
                updateCultivationLevelText();

                // If we just reached Immortal, immediately update button visibility
                if (cultivationLevel >= levelText.length - 2) {
                    updateButtonVisibility();
                }
            }
        }

        function addToScore() {
            // Calculate click multiplier from amulets
            let clickMultiplier = 1;
            equippedAmulets.forEach(amulet => {
                if (amulet.type === 'power') {
                    clickMultiplier *= amulet.multiplier;
                }
            });
            
            qi += qiPerClick * rebirthMultiplier * clickMultiplier;
            updateDisplay();
        }

        function formatNumber(value) {
            if (value >= 1e24) {
                return (value / 1e24).toFixed(1) + 'Sp'; // Septillion
            } else if (value >= 1e21) {
                return (value / 1e21).toFixed(1) + 'S'; // Sextillion
            } else if (value >= 1e18) {
                return (value / 1e18).toFixed(1) + 'Qi'; // Quintillion
            } else if (value >= 1e15) {
                return (value / 1e15).toFixed(1) + 'Q'; // Quadrillions
            } else if (value >= 1e12) {
                return (value / 1e12).toFixed(1) + 'T'; // Trillions
            } else if (value >= 1e9) {
                return (value / 1e9).toFixed(1) + 'B'; // Billions
            } else if (value >= 1e6) {
                return (value / 1e6).toFixed(1) + 'M'; // Millions
            } else if (value >= 1e3) {
                return (value / 1e3).toFixed(1) + 'k'; // Thousands
            } else {
                return value.toString(); // Less than a thousand
            }
        }

        function updateDisplay() {
            // Round down the Qi value and format it
            document.getElementById("qi").innerHTML = formatNumber(Math.floor(qi));
            document.getElementById("qiPerSecond").innerHTML = formatNumber(Math.floor(currentQiPerSecond));
            document.getElementById("breakthroughCost").innerHTML = formatNumber(Math.floor(breakthroughCost));
            document.getElementById("rebirthCost").innerText = formatNumber(Math.floor(calculateRebirthCost()));
            document.getElementById("rebirthCount").innerText = rebirthCount;
            document.getElementById("rebirthMultiplier").innerText = rebirthMultiplier;
            updateProgress(Math.floor(qi));
        }

        function updateProgress(qi) {
            const progressBar = document.querySelector('.progress-bar');
            const currentCost = cultivationLevel >= levelText.length - 1 ? calculateRebirthCost() : breakthroughCost;
            const progressPercentage = Math.min(100, (qi / currentCost) * 100);
            progressBar.style.width = progressPercentage + '%';
        }

        function updateCultivationLevelText() {
            const cultivationLevelText = levelText[cultivationLevel + 1] || "Immortal";
            document.getElementById("cultivationLevelText").innerText = cultivationLevelText;
            updateButtonVisibility();
        }

        function updateButtonVisibility() {
            const buttonContainer = document.getElementById("button-container");
            const breakthroughButton = document.getElementById("breakthrough-button");
            const rebirthButton = document.getElementById("rebirth-button");
            
            // Debug log for button visibility check
            console.log("Checking button visibility. Level:", cultivationLevel, "Is Immortal:", cultivationLevel >= levelText.length - 2);
            
            if (cultivationLevel >= levelText.length - 2) { // Changed from length - 1 to length - 2
                // At Immortal, remove breakthrough button and show rebirth button
                if (breakthroughButton) {
                    breakthroughButton.remove();
                }
                rebirthButton.style.display = "block";
                rebirthButton.innerHTML = `
                    <div class="progress-bar"></div>
                    Rebirth <span id="rebirthCost">${formatNumber(calculateRebirthCost())}</span>
                `;
            } else {
                // Not at Immortal, ensure breakthrough button exists
                if (!breakthroughButton) {
                    const newBreakthroughButton = document.createElement("button");
                    newBreakthroughButton.id = "breakthrough-button";
                    newBreakthroughButton.className = "breakthrough-button rounded";
                    newBreakthroughButton.onclick = breakthrough;
                    newBreakthroughButton.innerHTML = `
                        <div class="progress-bar"></div>
                        Breakthrough <span id="breakthroughCost">${formatNumber(breakthroughCost)}</span>
                    `;
                    buttonContainer.insertBefore(newBreakthroughButton, rebirthButton);
                }
                rebirthButton.style.display = "none";
            }
        }

        // Update Qi based on qiPerSecond every second
        setInterval(function() { 
            if (cultivationLevel < levelText.length - 1) {
                qi += currentQiPerSecond;
                updateDisplay();
            }
        }, 1000);

        function generateAmulet() {
            // Determine tier based on chances
            let roll = Math.random();
            let selectedTier = "wooden";
            let cumulativeChance = 0;
            
            for (const [tier, data] of Object.entries(amuletTiers)) {
                cumulativeChance += data.chance;
                if (roll <= cumulativeChance) {
                    selectedTier = tier;
                    break;
                }
            }

            // Determine type (50/50 chance)
            const type = Math.random() < 0.5 ? "power" : "patience";
            
            return {
                id: Date.now() + Math.random(),
                tier: selectedTier,
                type: type,
                multiplier: amuletTiers[selectedTier].multiplier
            };
        }

        function updateMaxSlots() {
            if (rebirthCount >= 10) {
                maxEquippedSlots = 4;
            } else if (rebirthCount >= 5) {
                maxEquippedSlots = 3;
            } else {
                maxEquippedSlots = 2;
            }
            updateInventoryDisplay();
        }

        function toggleInventory() {
            const menu = document.getElementById("inventory-menu");
            menu.style.display = menu.style.display === "none" ? "block" : "none";
        }

        function updateInventoryDisplay() {
            const inventoryGrid = document.getElementById("inventory-grid");
            const equipmentSlots = document.getElementById("equipment-slots");
            
            // Clear existing displays
            inventoryGrid.innerHTML = "";
            equipmentSlots.innerHTML = "";

            // Create equipment slots (always show all possible slots)
            for (let i = 0; i < 4; i++) {
                const slot = document.createElement("div");
                slot.className = "equipment-slot";
                
                if (i < maxEquippedSlots) {
                    // Available slot
                    slot.innerHTML = `
                        <div class="amulet-slot ${equippedAmulets[i] ? 'filled' : ''}" 
                             onclick="unequipAmulet(${i})">
                            ${equippedAmulets[i] ? formatAmuletDisplay(equippedAmulets[i]) : 'Empty Slot'}
                        </div>
                    `;
                } else {
                    // Locked slot
                    const rebirthsNeeded = i === 2 ? 5 : 10;
                    slot.innerHTML = `
                        <div class="amulet-slot locked">
                            <div class="locked-text">Locked</div>
                            <div class="rebirth-requirement">${rebirthsNeeded} Rebirths Required</div>
                        </div>
                    `;
                }
                equipmentSlots.appendChild(slot);
            }

            // Display inventory
            inventory.forEach((amulet, index) => {
                const amuletElement = document.createElement("div");
                amuletElement.className = "amulet-item";
                amuletElement.innerHTML = formatAmuletDisplay(amulet);
                amuletElement.onclick = () => equipAmulet(index);
                inventoryGrid.appendChild(amuletElement);
            });
        }

        function formatAmuletDisplay(amulet) {
            return `
                <div class="amulet ${amulet.tier}">
                    <div class="amulet-name">${amulet.tier.charAt(0).toUpperCase() + amulet.tier.slice(1)} Amulet of ${amuletTypes[amulet.type].name}</div>
                    <div class="amulet-effect">${amulet.multiplier}x ${amulet.type === 'power' ? 'Click' : 'Qi/s'} Power</div>
                </div>
            `;
        }

        function equipAmulet(inventoryIndex) {
            // Check if we have an available slot
            if (equippedAmulets.length >= maxEquippedSlots) {
                return; // Don't equip if no slots available
            }
            
            // Check if the slot we're trying to use is locked
            const nextSlotIndex = equippedAmulets.length;
            if (nextSlotIndex >= maxEquippedSlots) {
                return; // Don't equip if the slot is locked
            }

            equippedAmulets.push(inventory[inventoryIndex]);
            inventory.splice(inventoryIndex, 1);
            updateInventoryDisplay();
            updateQiPerSecond(); // Update qi/s when equipping amulets
        }

        function unequipAmulet(slotIndex) {
            // Check if the slot is valid and has an amulet
            if (slotIndex >= maxEquippedSlots || !equippedAmulets[slotIndex]) {
                return; // Don't unequip if slot is locked or empty
            }

            inventory.push(equippedAmulets[slotIndex]);
            equippedAmulets.splice(slotIndex, 1);
            updateInventoryDisplay();
            updateQiPerSecond(); // Update qi/s when unequipping amulets
        }

        function rebirth() {
            if (qi >= calculateRebirthCost()) {
                qi = 0;
                qiPerSecond = 0;
                qiPerClick = 1;
                breakthroughCost = 25;
                cultivationLevel = -1;
                rebirthCount++;
                rebirthMultiplier *= 2;

                // Generate new amulet
                inventory.push(generateAmulet());

                // Update max slots based on rebirth count
                updateMaxSlots();

                // Update qi/s calculation
                updateQiPerSecond();

                // Update display
                document.getElementById("rebirthCount").innerText = rebirthCount;
                document.getElementById("rebirthMultiplier").innerText = rebirthMultiplier;

                // Reset buttons
                const buttonContainer = document.getElementById("button-container");
                buttonContainer.innerHTML = `
                    <button onclick="breakthrough()" id="breakthrough-button" class="breakthrough-button rounded">
                        <div class="progress-bar"></div>
                        Breakthrough <span id="breakthroughCost">25</span>
                    </button>
                    <button onclick="rebirth()" id="rebirth-button" class="breakthrough-button rounded" style="display: none;">
                        <div class="progress-bar"></div>
                        Rebirth <span id="rebirthCost">25</span>
                    </button>
                    <p class="rebirth-info">Rebirth <span id="rebirthCount">0</span> - <span id="rebirthMultiplier">1</span>x</p>
                `;

                updateDisplay();
                updateCultivationLevelText();
            }
        }

        // Add save/load functionality for amulets
        function saveGame() {
            const gameState = {
                qi: qi,
                qiPerSecond: qiPerSecond,
                currentQiPerSecond: currentQiPerSecond,
                qiPerClick: qiPerClick,
                rebirthMultiplier: rebirthMultiplier,
                rebirthCount: rebirthCount,
                breakthroughCost: breakthroughCost,
                cultivationLevel: cultivationLevel,
                inventory: inventory,
                equippedAmulets: equippedAmulets
            };
            localStorage.setItem('murimClickerSave', JSON.stringify(gameState));
        }

        function loadGame() {
            const savedGame = localStorage.getItem('murimClickerSave');
            if (savedGame) {
                const gameState = JSON.parse(savedGame);
                qi = gameState.qi;
                qiPerSecond = gameState.qiPerSecond;
                currentQiPerSecond = gameState.currentQiPerSecond || 0;
                qiPerClick = gameState.qiPerClick;
                rebirthMultiplier = gameState.rebirthMultiplier;
                rebirthCount = gameState.rebirthCount;
                breakthroughCost = gameState.breakthroughCost;
                cultivationLevel = gameState.cultivationLevel;
                inventory = gameState.inventory;
                equippedAmulets = gameState.equippedAmulets;
                selectedAvatar = localStorage.getItem('selectedAvatar') || 'male.png';
                updateAvatar();

                // Recalculate qi/s to ensure it's correct
                updateQiPerSecond();

                updateDisplay();
                updateCultivationLevelText();
                updateMaxSlots();
                updateInventoryDisplay();
            }
        }

        // Auto-save every minute
        setInterval(saveGame, 60000);

        // Load game on start
        loadGame();

        function showResetConfirmation() {
            document.getElementById("reset-confirmation").style.display = "flex";
        }

        function hideResetConfirmation() {
            document.getElementById("reset-confirmation").style.display = "none";
        }

        function resetGame() {
            // Reset all game variables
            qi = 0;
            qiPerSecond = 0;
            currentQiPerSecond = 0;
            qiPerClick = 1;
            rebirthMultiplier = 1;
            rebirthCount = 0;
            breakthroughCost = 25;
            cultivationLevel = -1;
            lastMajorBreakthrough = -1;
            inventory = [];
            equippedAmulets = [];
            maxEquippedSlots = 2;
            selectedAvatar = 'male.png';

            // Clear localStorage
            localStorage.removeItem('murimClickerSave');

            // Reset buttons
            const buttonContainer = document.getElementById("button-container");
            buttonContainer.innerHTML = `
                <button onclick="breakthrough()" id="breakthrough-button" class="breakthrough-button rounded">
                    <div class="progress-bar"></div>
                    Breakthrough <span id="breakthroughCost">25</span>
                </button>
                <button onclick="rebirth()" id="rebirth-button" class="breakthrough-button rounded" style="display: none;">
                    <div class="progress-bar"></div>
                    Rebirth <span id="rebirthCost">25</span>
                </button>
                <p class="rebirth-info">Rebirth <span id="rebirthCount">0</span> - <span id="rebirthMultiplier">1</span>x</p>
            `;

            // Update all displays
            updateQiPerSecond();
            updateDisplay();
            updateCultivationLevelText();
            updateMaxSlots();
            updateInventoryDisplay();

            // Hide confirmation dialog
            document.getElementById("reset-confirmation").style.display = "none";
        }

        function goToAvatarSelection() {
            window.location.href = 'avatar.html';
        }

        function updateAvatar() {
            const avatarImg = document.querySelector('.image.glow');
            if (avatarImg) {
                avatarImg.src = `images/${selectedAvatar}`;
                // Adjust position for female cultivator
                if (selectedAvatar === 'female.png') {
                    avatarImg.style.top = '40%'; // Move down by 25px from 35%
                } else {
                    avatarImg.style.top = '35%'; // Reset to original position
                }
            }
        }

    </script>
</body>
</html>
